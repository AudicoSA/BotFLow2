# Render Blueprint for BotFlow2 Backend
# https://docs.render.com/blueprint-spec

services:
  # ===========================================
  # Main Web Application
  # ===========================================
  - type: web
    name: botflow-api
    runtime: docker
    dockerfilePath: ./Dockerfile
    dockerContext: .
    region: frankfurt # Closest to South Africa
    plan: starter # Can upgrade to standard for auto-scaling
    branch: main
    autoDeploy: true
    healthCheckPath: /api/health
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 3000
      - key: NEXT_PUBLIC_APP_URL
        sync: false
      - key: NEXT_PUBLIC_SUPABASE_URL
        sync: false
      - key: NEXT_PUBLIC_SUPABASE_ANON_KEY
        sync: false
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false
      - key: PAYSTACK_SECRET_KEY
        sync: false
      - key: PAYSTACK_PUBLIC_KEY
        sync: false
      - key: PAYSTACK_WEBHOOK_SECRET
        sync: false
      - key: OPENAI_API_KEY
        sync: false
      - key: META_APP_ID
        sync: false
      - key: META_APP_SECRET
        sync: false
      - key: META_ACCESS_TOKEN
        sync: false
      - key: WHATSAPP_PHONE_NUMBER_ID
        sync: false
      - key: WHATSAPP_BUSINESS_ACCOUNT_ID
        sync: false
      - key: WHATSAPP_WEBHOOK_VERIFY_TOKEN
        sync: false
      - key: JWT_SECRET
        sync: false
      - key: REDIS_URL
        fromService:
          type: redis
          name: botflow-redis
          property: connectionString
    scaling:
      minInstances: 1
      maxInstances: 3
      targetMemoryPercent: 80
      targetCPUPercent: 80

  # ===========================================
  # Background Worker
  # ===========================================
  - type: worker
    name: botflow-worker
    runtime: docker
    dockerfilePath: ./Dockerfile.worker
    dockerContext: .
    region: frankfurt
    plan: starter
    branch: main
    autoDeploy: true
    envVars:
      - key: NODE_ENV
        value: production
      - key: REDIS_URL
        fromService:
          type: redis
          name: botflow-redis
          property: connectionString
      - key: NEXT_PUBLIC_SUPABASE_URL
        sync: false
      - key: NEXT_PUBLIC_SUPABASE_ANON_KEY
        sync: false
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false
      - key: PAYSTACK_SECRET_KEY
        sync: false
      - key: OPENAI_API_KEY
        sync: false
      - key: RESEND_API_KEY
        sync: false

databases:
  # ===========================================
  # Redis for BullMQ
  # ===========================================
  - name: botflow-redis
    plan: starter # 25MB, can upgrade to standard for 100MB
    ipAllowList: [] # Allow from all Render services

# Preview environments
previewsEnabled: true
previewsExpireAfterDays: 7
